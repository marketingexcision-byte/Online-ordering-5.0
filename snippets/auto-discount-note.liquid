{%- comment -%}
  Shows "NN% discount applied at checkout".
  For logged-in customers, it tries to resolve a customer-specific discount based on product tags.
  Order of resolution.
  1) Category match using the map below.
  2) Fallback to store_wide_discount (customer metafield).
  3) Fallback to collection sale metaobject (custom.sale_discount -> website_sale).
     * discount (Decimal)
     * sale_name (Single line text)
  Collection sale discount shows even for guests.
{%- endcomment -%}

{%- comment -%} Resolve product object for PDP and cards {%- endcomment -%}
{%- assign p = product | default: card_product | default: item | default: item_product | default: nil -%}
{%- if p and p.object_type == blank and p.product -%}
  {%- assign p = p.product -%}
{%- endif -%}

{%- assign show_pct = nil -%}
{%- assign sale_label = nil -%}

{%- comment -%}
  1. CUSTOMER-BASED DISCOUNT (only if customer is logged in)
{%- endcomment -%}
{%- if customer and p -%}
  {%- comment -%} Tag â†’ customer metafield key map {%- endcomment -%}
  {%- assign discount_map = '
    ISO Inserts:insert_discount|
    Taps:taps_discount|
    drills:drills_discount|
    end mills:end_mills_discount|
    coldsaw machines:coldsaw_machines_discount|
    punch dies:punch_dies_discount|
    core drills acc:core_drills_acc_discount|
    magnetic drills:magnetic_drills_discount|
    coolant:coolant_discount|
    tct circular blade:tct_circular_blade_discount|
    coldsaw blade:coldsaw_blade_discount|
    bandsaw blade:bandsaw_blade_discount|
    bandsaw machines:bandsaw_machines_discount'
    | strip
  -%}

  {%- assign mapping_pairs = discount_map | split: '|' -%}
  {%- assign product_tags_downcased = p.tags | join: '||' | downcase | split: '||' -%}

  {%- for pair in mapping_pairs -%}
    {%- assign parts = pair | strip | split: ':' -%}
    {%- assign tag_label = parts[0] | strip | downcase -%}
    {%- assign meta_key = parts[1] | strip -%}

    {%- if product_tags_downcased contains tag_label -%}
      {%- assign raw_val = customer.metafields.custom[meta_key] -%}
      {%- assign pct = raw_val | default: 0 | plus: 0 -%}
      {%- if pct > 0 -%}
        {%- assign show_pct = pct -%}
        {%- break -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- if show_pct == nil or show_pct == 0 -%}
    {%- assign storewide_raw = customer.metafields.custom.store_wide_discount -%}
    {%- assign storewide_pct = storewide_raw | default: 0 | plus: 0 -%}
    {%- if storewide_pct > 0 -%}
      {%- assign show_pct = storewide_pct -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}


{%- comment -%}
  2. COLLECTION-LEVEL SALE (metaobject)
{%- endcomment -%}
{%- if p -%}
  {%- if show_pct == nil or show_pct == 0 -%}

    {%- assign best_coll_pct = 0 -%}
    {%- assign best_sale_label = nil -%}

    {%- comment -%}Check explicit collection in context first{%- endcomment -%}
    {%- if collection -%}
      {%- assign col = collection -%}
      {%- assign sale_ref = col.metafields.custom.sale_discount -%}
      {%- if sale_ref != blank -%}
        {%- assign sale = sale_ref.value | default: sale_ref -%}
        {%- assign coll_pct = sale.discount | default: 0 | plus: 0 -%}
        {%- assign coll_name = sale.sale_name | default: '' -%}
        {%- if coll_pct > best_coll_pct -%}
          {%- assign best_coll_pct = coll_pct -%}
          {%- assign best_sale_label = coll_name -%}
        {%- endif -%}
      {%- elsif col.metafields.custom.discount_must_create_discount and col.metafields.custom.discount_must_create_discount > 0 -%}
        {%- assign coll_pct = col.metafields.custom.discount_must_create_discount | plus: 0 -%}
        {%- if coll_pct > best_coll_pct -%}
          {%- assign best_coll_pct = coll_pct -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}

    {%- comment -%}Then check all collections the product belongs to{%- endcomment -%}
    {%- if p.collections and p.collections.size > 0 -%}
      {%- for col in p.collections -%}
        {%- assign sale_ref = col.metafields.custom.sale_discount -%}
        {%- if sale_ref != blank -%}
          {%- assign sale = sale_ref.value | default: sale_ref -%}
          {%- assign coll_pct = sale.discount | plus: 0 -%}
          {%- assign coll_name = sale.sale_name | default: '' -%}
        {%- elsif col.metafields.custom.discount_must_create_discount and col.metafields.custom.discount_must_create_discount > 0 -%}
          {%- assign coll_pct = col.metafields.custom.discount_must_create_discount | plus: 0 -%}
          {%- assign coll_name = '' -%}
        {%- else -%}
          {%- assign coll_pct = 0 -%}
          {%- assign coll_name = '' -%}
        {%- endif -%}

        {%- if coll_pct > best_coll_pct -%}
          {%- assign best_coll_pct = coll_pct -%}
          {%- assign best_sale_label = coll_name -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if best_coll_pct > 0 -%}
      {%- assign show_pct = best_coll_pct -%}
      {%- assign sale_label = best_sale_label -%}
    {%- endif -%}

  {%- endif -%}
{%- endif -%}


{%- comment -%} Format % . integers show without .0 . decimals left as-is {%- endcomment -%}
{%- assign rounded_pct = show_pct | default: 0 | round: 0 -%}
{%- if rounded_pct == show_pct -%}
  {%- assign display_pct = rounded_pct -%}
{%- else -%}
  {%- assign display_pct = show_pct -%}
{%- endif -%}

{%- if show_pct and show_pct > 0 -%}
  <div class="auto-discount-note" role="status" aria-live="polite">
    <span class="auto-discount-note__icon" aria-hidden="true">
      <svg width="16" height="16" viewBox="0 0 24 24" focusable="false">
        <path fill="#f88d2b" d="M20.59 13.41l-7.18 7.18a2 2 0 0 1-2.83 0l-7.17-7.17A2 2 0 0 1 3 12.17V5a2 2 0 0 1 2-2h7.17a2 2 0 0 1 1.41.59l7.01 7.01a2 2 0 0 1 0 2.81ZM7.5 7A1.5 1.5 0 1 0 9 8.5A1.5 1.5 0 0 0 7.5 7Z"/>
      </svg>
    </span>
    <div class="auto-discount-note__text">
      {%- if sale_label and sale_label != '' -%}
        <div class="auto-discount-note__sale-name">{{ sale_label }}</div>
      {%- endif -%}
      <div>{{ display_pct }}% discount applied at checkout</div>
    </div>
  </div>
  <style>
    .auto-discount-note {
      margin-top: var(--space-4);
      margin-bottom: var(--space-4);
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      line-height: 1.2;
    }
    .auto-discount-note__icon {
      display: inline-flex;
      width: 1em;
      height: 1em;
    }
    .auto-discount-note__icon svg {
      width: 1em;
      height: 1em;
    }
    .auto-discount-note__text {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .auto-discount-note__sale-name {
      font-family: 'Humanist777BT-Bold';
    }
  </style>
{%- endif -%}
